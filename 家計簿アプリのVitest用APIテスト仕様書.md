æ§‹æˆï¼ˆNext.js + Express + Prisma + MySQLï¼‰ã‚’è¸ã¾ãˆãŸã€
**Vitest ç”¨ API ãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸
---

# ğŸŒ± å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª API ãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸

ï¼ˆVitestå¯¾å¿œãƒ»åˆå¿ƒè€…å‘ã‘ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆåæ˜ ç‰ˆï¼‰

---

# ğŸ—‚ï¸ 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“æ§‹æˆï¼ˆã‚ãªãŸã®æ§‹æˆãã®ã¾ã¾ï¼‰

```
kakeibo-app/
â”œâ”€â”€ client/                     â† ãƒ•ãƒ­ãƒ³ãƒˆï¼ˆNext.jsï¼‰
â”‚   â”œâ”€â”€ app/
â”‚   â””â”€â”€ components/
â”‚
â”œâ”€â”€ server/                     â† ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆExpress + Prismaï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ index.ts            â† ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
â”‚   â”‚   â””â”€â”€ routes/expenses.ts  â† å®¶è¨ˆç°¿API
â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â”œâ”€â”€ schema.prisma       â† Prismaã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”‚   â”œâ”€â”€ seed.ts             â† åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
â”‚   â”‚   â””â”€â”€ migrations/
â”‚   â””â”€â”€ package.json
â”‚
â””â”€â”€ docker-compose.yml          â† MySQLå®šç¾©
```

ã“ã® **server/** é…ä¸‹ã«ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹å½¢ãŒè‡ªç„¶**ã§ã™ã€‚

---

# ğŸ§ª 2. ãƒ†ã‚¹ãƒˆãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆï¼ˆserver å†…ã«è¨­ç½®ï¼‰

ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆæ§‹æˆã‚’ **server/** é…ä¸‹ã«è¿½åŠ ã—ã¾ã™ï¼š

```
server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ expenses.ts
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma
â”‚   â”œâ”€â”€ seed.ts
â”‚   â””â”€â”€ migrations/
â”‚
â”œâ”€â”€ tests/                     â† â˜… ãƒ†ã‚¹ãƒˆãƒ•ã‚©ãƒ«ãƒ€ï¼ˆæ–°è¦ï¼‰
â”‚   â”œâ”€â”€ setup.ts               â† DBåˆæœŸåŒ– & ã‚µãƒ¼ãƒãƒ¼æº–å‚™
â”‚   â”‚
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ register.spec.ts
â”‚   â”‚   â””â”€â”€ login.spec.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ expenses/              â† å®¶è¨ˆç°¿API
â”‚   â”‚   â”œâ”€â”€ list.spec.ts
â”‚   â”‚   â”œâ”€â”€ create.spec.ts
â”‚   â”‚   â”œâ”€â”€ update.spec.ts
â”‚   â”‚   â””â”€â”€ delete.spec.ts
â”‚   â”‚
â”‚   â””â”€â”€ stats/
â”‚       â””â”€â”€ monthly.spec.ts
â”‚
â””â”€â”€ package.json
```

---

# ğŸ” 3. å›³ã§ç†è§£ã™ã‚‹ API ãƒ†ã‚¹ãƒˆã®ä»•çµ„ã¿

ãƒ†ã‚¹ãƒˆãŒå‹•ãæµã‚Œã‚’åˆå¿ƒè€…å‘ã‘ã«å›³è§£ğŸ‘‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Vitest             â”‚
â”‚  ï¼ˆãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ supertest ã§HTTPã‚¢ã‚¯ã‚»ã‚¹
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Express ã‚µãƒ¼ãƒãƒ¼       â”‚
â”‚  ï¼ˆ/server/src/index.tsï¼‰ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ Prisma çµŒç”±ã§DBã‚¢ã‚¯ã‚»ã‚¹
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        MySQL ï¼ˆDockerï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ“˜ 4. ãƒ†ã‚¹ãƒˆæº–å‚™ï¼ˆsetup.tsï¼‰

## åŸºæœ¬ã®æµã‚Œï¼š

1. Docker ä¸Šã® MySQL ã¨æ¥ç¶š
2. Prisma migrate ã‚’å®Ÿè¡Œ
3. seed.ts ã§åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
4. Express ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
5. supertest ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

åˆå¿ƒè€…å‘ã‘ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã¯ã“ã‚ŒğŸ‘‡

### `server/tests/setup.ts`ï¼ˆä¾‹ï¼‰

```ts
import { beforeAll, afterAll } from "vitest";
import { PrismaClient } from "@prisma/client";
import { execSync } from "child_process";
import { app } from "../src/index";
import request from "supertest";

export const prisma = new PrismaClient();

beforeAll(async () => {
  // DBãƒªã‚»ãƒƒãƒˆ
  execSync("npx prisma migrate reset --force", { stdio: "inherit" });

  // seedæŠ•å…¥
  execSync("npx prisma db seed", { stdio: "inherit" });
});

afterAll(async () => {
  await prisma.$disconnect();
});
```

ğŸ“Œ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã§è‡ªå‹•çš„ã«èª­ã¿è¾¼ã‚€ã‚ˆã†ã«
`vitest.config.ts` ã§è¨­å®šã§ãã¾ã™ã€‚

---

# ğŸ§ª 5. å„ API ã®ãƒ†ã‚¹ãƒˆä»•æ§˜ï¼ˆåˆå¿ƒè€…å‘ã‘ã«ç°¡å˜ã«ï¼‰

---

# âœ¨ 5-1. èªè¨¼ API

## ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² `POST /api/auth/register`

### ç›®çš„ï¼ˆåˆå¿ƒè€…å‘ã‘ï¼‰

* æ­£ã—ã„å…¥åŠ› â†’ ç™»éŒ²æˆåŠŸ
* é–“é•ã£ãŸå…¥åŠ› â†’ ã¡ã‚ƒã‚“ã¨ã‚¨ãƒ©ãƒ¼

---

### âœ” æ­£å¸¸ç³»

| No | ã‚·ãƒŠãƒªã‚ª     | å…¥åŠ›                  | çµæœ  |
| -- | -------- | ------------------- | --- |
| 1  | æ­£ã—ãç™»éŒ²ã§ãã‚‹ | email/password/name | 201 |

---

### âŒ ç•°å¸¸ç³»

| No | ã‚·ãƒŠãƒªã‚ª     | å…¥åŠ›          | çµæœ  |
| -- | -------- | ----------- | --- |
| 2  | ãƒ¡ãƒ¼ãƒ«å½¢å¼ãŒä¸æ­£ | email="aaa" | 400 |
| 3  | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰çŸ­ã„  | "123"       | 400 |
| 4  | ãƒ¡ãƒ¼ãƒ«é‡è¤‡    | æ—¢å­˜ email    | 409 |

---

---

# âœ¨ 5-2. å®¶è¨ˆç°¿ APIï¼ˆexpensesï¼‰

---

## ğŸ“„ ä¸€è¦§å–å¾— `GET /api/expenses`

### âœ” æˆåŠŸç³»

| ã‚·ãƒŠãƒªã‚ª               | çµæœ         |
| ------------------ | ---------- |
| å…¨ä»¶å–å¾—               | 200ã€é…åˆ—è¿”å´   |
| type=expense ã§çµã‚Šè¾¼ã¿ | æ­£ã—ããƒ•ã‚£ãƒ«ã‚¿ã•ã‚Œã‚‹ |

### âŒ å¤±æ•—ç³»

| ã‚·ãƒŠãƒªã‚ª | çµæœ  |
| ---- | --- |
| èªè¨¼ãªã— | 401 |

---

## â• ä½œæˆ `POST /api/expenses`

| ã‚·ãƒŠãƒªã‚ª    | çµæœ  |
| ------- | --- |
| æ­£å¸¸å…¥åŠ›    | 201 |
| é‡‘é¡ãŒãƒã‚¤ãƒŠã‚¹ | 400 |
| å¿…é ˆé …ç›®ãªã—  | 400 |

---

## ğŸ“ æ›´æ–° `PUT /api/expenses/:id`

| ã‚·ãƒŠãƒªã‚ª  | çµæœ  |
| ----- | --- |
| ID æ­£å¸¸ | 200 |
| ID ä¸æ­£ | 404 |
| ãƒ‡ãƒ¼ã‚¿ä¸æ­£ | 400 |

---

## âŒ å‰Šé™¤ `DELETE /api/expenses/:id`

| ã‚·ãƒŠãƒªã‚ª | çµæœ  |
| ---- | --- |
| æ­£å¸¸å‰Šé™¤ | 204 |
| IDä¸æ­£ | 404 |

---

---

# ğŸ“Š 5-3. æœˆæ¬¡é›†è¨ˆ API

`GET /api/stats/monthly?year=2024&month=5`

| ã‚·ãƒŠãƒªã‚ª     | çµæœ  |
| -------- | --- |
| æ­£ã—ã„å¹´æœˆ    | 200 |
| month=13 | 400 |

---

# ğŸ§ª 6. ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¾‹ï¼ˆã‚ãªãŸã®æ§‹æˆã«å®Œå…¨å¯¾å¿œï¼‰

`server/tests/auth/register.spec.ts`

```ts
import request from "supertest";
import { describe, it, expect } from "vitest";
import "../setup"; // â† DB åˆæœŸåŒ–ã‚’èª­ã¿è¾¼ã‚€

import { app } from "../../src/index";

describe("POST /api/auth/register", () => {
  it("æ­£ã—ãç™»éŒ²ã§ãã‚‹", async () => {
    const res = await request(app)
      .post("/api/auth/register")
      .send({
        email: "test@example.com",
        password: "password123",
        name: "Taro"
      });

    expect(res.status).toBe(201);
    expect(res.body).toHaveProperty("id");
  });

  it("ãƒ¡ãƒ¼ãƒ«å½¢å¼ã‚¨ãƒ©ãƒ¼", async () => {
    const res = await request(app)
      .post("/api/auth/register")
      .send({
        email: "invalid",
        password: "password123",
        name: "Taro"
      });

    expect(res.status).toBe(400);
  });
});
```

---

# ğŸ¯ 7. æœ€å¾Œã«ï¼šåˆå¿ƒè€…ãŒãƒãƒã‚‰ãªã„ãƒã‚¤ãƒ³ãƒˆ

* ãƒ†ã‚¹ãƒˆã¯ **server/** ã«ã ã‘æ›¸ãï¼ˆclient ã¯é–¢ä¿‚ãªã—ï¼‰
* Prisma ã® migrate / seed ã‚’ãƒ†ã‚¹ãƒˆå‰ã«å®Ÿè¡Œã™ã‚‹
* supertest ã§ â€œç”Ÿã® APIâ€ ã‚’å©ãã®ã§å®Ÿè£…ã‚’ãã®ã¾ã¾ãƒ†ã‚¹ãƒˆã§ãã‚‹
* Docker ã® MySQL ãŒå¿…é ˆï¼ˆç«‹ã¡ä¸Šã’å¿˜ã‚Œæ³¨æ„ï¼‰